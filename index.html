<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  
  <!-- Production BikeTag Client -->
  <script src="https://cdn.jsdelivr.net/npm/biketag/biketag.js"></script>
  
  <!-- Local BikeTag Client -->
  <!-- <script src="/node_modules/biketag/biketag.js"></script> -->

  <!-- Lazy Load Client -->
  <script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.js"></script>
  
  <!-- Styles -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial;
    }

    .header {
      text-align: center;
      padding: 32px;
    }

    .row {
      display: -ms-flexbox;
      /* IE10 */
      display: flex;
      -ms-flex-wrap: wrap;
      /* IE10 */
      flex-wrap: wrap;
      padding: 0 4px;
    }

    /* Create four equal columns that sits next to each other */
    .column {
      -ms-flex: 25%;
      /* IE10 */
      flex: 25%;
      max-width: 25%;
      padding: 0 4px;
    }

    .column img {
      margin-top: 8px;
      vertical-align: middle;
      width: 100%;
    }

    /* Responsive layout - makes a two column-layout instead of four columns */
    @media screen and (max-width: 800px) {
      .column {
        -ms-flex: 50%;
        flex: 50%;
        max-width: 50%;
      }
    }

    /* Responsive layout - makes the two columns stack on top of each other instead of next to each other */
    @media screen and (max-width: 600px) {
      .column {
        -ms-flex: 100%;
        flex: 100%;
        max-width: 100%;
      }
    }

    #pages {
      position: relative;
    }

    #loaderContainer {
      margin: 0px;
      display: none;
      padding: 0px;
      position: absolute;
      right: 0px;
      top: 0px;
      width: 100%;
      height: 100%;
      background-color: rgb(255, 255, 255);
      z-index: 30001;
      opacity: 0.8;
    }

    #loaderContainer.loading {
      display: block;
    }

    #loaderContainer.loading #loader {
      position: absolute;
      color: White;
      top: 50%;
      left: 45%;
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      width: 120px;
      height: 120px;
      background-color: rgba(0, 0, 0, 45);
      -webkit-animation: spin 2s linear infinite;
      /* Safari */
      animation: spin 2s linear infinite;
    }

    /* Safari */
    @-webkit-keyframes spin {
      0% {
        -webkit-transform: rotate(0deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loaderContainer">
    <div id="loader"></div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>BikeTag Starter</h1>
    <p>See all of the images for the <span id="game"></span> game.</p>
    <select id="gameChanger" onChange="changeGame(this);">
      <option></option>
    </select>
  </div>

  <!-- Pagination -->
  <div id="pages" style="text-align: center">
    <div>
      <a href="javascript:prevPage()" id="btn_prev">Prev</a>
      <a href="javascript:nextPage()" id="btn_next">Next</a>
      page: <span id="page"></span>
    </div>
    <div id="pageContent"></div>
  </div>

  <!-- Code -->
  <script>
    let num_pages = 0;
    let current_page = 1;
    let previous_page = current_page;
    const rows_per_page = 3;

    /// Configure BikeTag API Opts
    const options = {
      imgur: {
        clientId: "IMGUR_CLIENT_ID",
        clientSecret: "IMGUR_CLIENT_SECRET",
      },
      sanity: {
        projectId: "SANITY_PROJECT_ID",
        dataset: "SANITY_DATASET",
      },
      reddit: {
        clientId: "REDDIT_CLIENT_ID",
        clientSecret: "REDDIT_CLIENT_SECRET",
        username: "REDDIT_USERNAME",
        password: "REDDIT_PASSWORD",
      },
    }

    /// Setup
    const getBikeTagApi = (opts, reinitialize = false) => {
      if (!window.biketagApi) {
        window.biketagApi = new biketag(opts)
      } else {
        console.log('setting new BikeTag config', {
          config: window.biketagApi.setConfiguration(opts, false, reinitialize)
        })
      }

      return window.biketagApi
    }

    /// Change Game Selector Event
    const changeGame = async (elem) => {
      if (elem.selectedIndex > -1) {
        load({
          ...options,
          game: elem[elem.selectedIndex].value
        })
      }
    }

    /// Load BikeTag Game Data into UI
    const load = async (opts) => {
      const loaderEl = document.getElementById('loaderContainer')
      loaderEl.classList.add('loading')

      opts.game = opts.game ? opts.game : 'test'
      let biketagAPI = getBikeTagApi(opts, true)
      const game = await biketagAPI.getGameData(opts.game)
      const pagesEl = document.getElementById('pageContent')

      pagesEl.innerHTML = ""
      num_pages = 0
      current_page = previous_page = 1

      const createImage = (url) => {
        const imgEl = document.createElement('img')
        const ext = /[^.]+$/.exec(url)
        if (['.jpg', '.jpeg', '.png', '.bmp'].indexOf(ext) !== -1) {
          url = url.replace(ext, `l${ext}`)
        } else if (ext.indexOf('.com/') === 0 && url.indexOf('//imgur.com/')) {
          url = `${url.replace('//imgur.com', '//i.imgur.com')}l.jpg`
        }

        imgEl.dataset.src = url
        imgEl.class = 'lazyload'
        imgEl.style = "width:100%;max-width:35vw"

        return imgEl
      }

      const createPage = (num = 1, rows = 4) => {
        const pageEl = document.createElement('div')

        pageEl.id = `page-${num}`
        pageEl.class = 'row'

        if (num > 1) {
          pageEl.style.display = "none";
          pageEl.style.visibility = "hidden";
        }

        for (let i = 1; i <= rows; i++) {
          const columnEl = document.createElement('div')

          columnEl.class = 'column'
          columnEl.id = `c${i}`
          pageEl.append(columnEl)
        }

        return pageEl
      }

      if (game.data) {
        const gameTextEl = document.getElementById("game")
        gameTextEl.innerText = game.data.name

        biketagAPI = getBikeTagApi({
          ...opts,
          imgur: {
            hash: game.data.mainhash,
          },
          reddit: {
            subreddit: game.data.subreddit,
          },
        }, true)
        const config = biketagAPI.getConfiguration()

        const albumTagsData = await biketagAPI.getTags(undefined, config.imgur.hash ? {
          source: 'imgur'
        } : {
          source: 'reddit',
          hash: 'n0'
        })
        const biketags = albumTagsData && albumTagsData.data ? albumTagsData.data : []
        window.biketags = biketags

        console.info(
          `BikeTag Client Configured -> ${biketags.length ? 'BikeTags Retrieved' : `No BikeTags For Game: ${game.data.name}`}`, {
            game: game.data,
            biketags,
          })

        if (biketags.length) {
          const imagesToLoad = []
          let pageContentEl = null
          let columns = []
          for (let i = 0, j = 0, k = 0; i < biketags.length; ++i) {
            const foundImageUrl = biketags[i].foundImageUrl
            const mysteryImgUrl = biketags[i].mysteryImageUrl

            if (!(mysteryImgUrl || foundImageUrl)) {
              return
            }

            if (k === 0) {
              /// Create new page
              k++
              pageContentEl = createPage(++num_pages)

              columns = [
                pageContentEl.querySelector('#c1'),
                pageContentEl.querySelector('#c2'),
                pageContentEl.querySelector('#c3'),
                pageContentEl.querySelector('#c4'),
              ]
            }

            if (foundImageUrl) {
              const foundImage = createImage(foundImageUrl)
              imagesToLoad.push(foundImage)
              columns[j++].appendChild(foundImage)
            }

            if (j > 3) {
              j = 0
              k++
            }

            if (mysteryImgUrl) {
              const mysteryImage = createImage(mysteryImgUrl)
              imagesToLoad.push(mysteryImage)
              columns[j++].appendChild(mysteryImage)
            }

            if (j > 3) {
              j = 0
              k++
            }

            if (k > rows_per_page) {
              pagesEl.appendChild(pageContentEl)
              pageContentEl = null
              k = 0
            }
          }

          if (pageContentEl) {
            pagesEl.appendChild(pageContentEl)
          }

          lazyload(imagesToLoad)
          changePage(1)
        }
      loaderEl.classList.remove('loading')
      }
    }

    /// Populate the Change Game Selector from all available games
    const setAllGames = async (opts) => {
      const biketagAPI = getBikeTagApi(opts, true)
      const allGames = await biketagAPI.getGameData()

      if (allGames.data && allGames.data.length) {
        const gameChangerEl = document.getElementById('gameChanger')
        for (let game of allGames.data) {
          const gameSelectEl = document.createElement('option')
          gameSelectEl.text = game.name
          gameSelectEl.value = game.slug
          gameChangerEl.appendChild(gameSelectEl)
        }
      }
    }

    /// ... Pagination Methods ... ///
    const prevPage = () => {
      if (current_page > 1) {
        previous_page = current_page;
        current_page--;
        changePage(current_page);
      }
    }

    const nextPage = () => {
      if (current_page < numPages()) {
        previous_page = current_page;
        current_page++;
        changePage(current_page);
      }
    }

    const changePage = (page) => {
      var btn_next = document.getElementById("btn_next");
      var btn_prev = document.getElementById("btn_prev");
      var pageContentEls = document.querySelectorAll("#pageContent > *");
      var page_span = document.getElementById("page");

      // Validate page
      if (page < 1) page = 1;
      if (page > numPages()) page = numPages();

      console.log('changePage', {
        page,
        pageContentEls,
        current_page,
        previous_page
      })
      if (pageContentEls.length) {
        if (previous_page < pageContentEls.length) {
          pageContentEls[previous_page - 1].style.display = "none";
          pageContentEls[previous_page - 1].style.visibility = "hidden";
        }

        pageContentEls[current_page - 1].style.display = "flex";
        pageContentEls[current_page - 1].style.visibility = "visible";
      }
      page_span.innerHTML = page + "/" + numPages();

      if (page == 1) {
        btn_prev.style.visibility = "hidden";
      } else {
        btn_prev.style.visibility = "visible";
      }

      if (page == numPages()) {
        btn_next.style.visibility = "hidden";
      } else {
        btn_next.style.visibility = "visible";
      }
    }

    const numPages = () => {
      return Math.ceil(num_pages / rows_per_page);
    }

    /// ... BOOTSTRAP ... ///
    setAllGames(options)

    /// ... LOAD .. ///
    window.onload = function () {
      changePage(1);
    };
  </script>
</body>

</html>
